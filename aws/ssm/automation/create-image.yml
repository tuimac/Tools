description: Create Image
schemaVersion: '0.3'
parameters:
  InstanceHostname:
    type: String
    description: (Required)
  Retention:
    type: String
    description: (Required)
mainSteps:
  - name: GetDeleteImageId
    action: aws:executeScript
    timeoutSeconds: 3600
    onFailure: Abort
    inputs:
      Runtime: python3.8
      Handler: handler
      InputPayload:
        InputPayload:
          Hostname: '{{ InstanceHostname }}'
          Retention: '{{ Retention }}'
      Script: |-
        import boto3
        def handler(events, context):
          # Initialization
          hostname = events['Hostname']
          retention = events['Retention']
          ec2 = boto3.client('ec2')
          target_images = []

          # Get target images information
          images = ec2.describe_images(
            Owner = ['self'],
            Filters = [{
              'Name': 'tag:HostName',
              'Values': [hostname]
            }]
          )['Images']

          # Extract target images over the retention
          images.sort(key=lambda sort_key: sort_key.get('CreationDate'), reverse=True)
          return {'DeleteTargets': images[retention:]}
    outputs:
      - Name: DeleteTargets
        Selector: $.Payload.DeleteTargets
        Type: List
  - name: DeleteImages
    action: aws:executeScript
    timeoutSeconds: 3600
    onFailure: Abort
    inputs:
      Runtime: python3.8
      Handler: handler
      InputPayload:
        InputPayload:
          DeleteTargets: '{{ GetDeleteImageId.DeleteTargets }}'
      Script: |-
        import boto3
        def handler(event, context):
           
